{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - {{ site_name }}{% endblock %}
{% block meta_robots %}noindex, nofollow{% endblock %}

{% block content %}
<!-- Hero -->
<section class="pt-28 pb-12 bg-gradient-to-b from-gray-950 via-gray-900 to-gray-950 text-white">
    <div class="max-w-4xl mx-auto px-4 text-center">
        <i class="fas fa-lock text-4xl text-red-500 mb-4 block"></i>
        <h1 class="text-3xl md:text-4xl font-extrabold mb-2">Checkout</h1>
        <p class="text-gray-400">Completa tus datos para finalizar la compra</p>
    </div>
</section>

<section class="py-12 bg-gray-950">
    <div class="max-w-5xl mx-auto px-4">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">

            <!-- Customer Form (3 cols) -->
            <div class="lg:col-span-3">

                {% if not user.is_authenticated %}
                <!-- Banner: invite to register -->
                <div class="bg-blue-900/20 border border-blue-500/30 rounded-2xl p-5 mb-6 flex items-start gap-4">
                    <div class="w-10 h-10 bg-blue-500/10 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5">
                        <i class="fas fa-user-plus text-blue-400"></i>
                    </div>
                    <div>
                        <p class="text-white text-sm font-semibold mb-1">¿Ya tienes cuenta?</p>
                        <p class="text-gray-400 text-xs mb-3">Inicia sesión para completar tu compra más rápido con tus datos guardados, o regístrate para futuras compras.</p>
                        <div class="flex items-center gap-3">
                            <a href="{% url 'login' %}?next={% url 'store:checkout' %}" class="inline-flex items-center gap-1.5 px-4 py-2 text-xs font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">
                                <i class="fas fa-sign-in-alt"></i> Iniciar sesión
                            </a>
                            <a href="{% url 'signup' %}?next={% url 'store:checkout' %}" class="inline-flex items-center gap-1.5 px-4 py-2 text-xs font-semibold text-blue-400 bg-blue-500/10 rounded-lg hover:bg-blue-500/20 transition">
                                <i class="fas fa-user-plus"></i> Registrarse
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="bg-gray-900 border border-gray-800 rounded-2xl p-6">
                    <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                        <i class="fas fa-user text-red-500"></i> <span id="checkout-section-title">Datos de envío</span>
                        {% if user.is_authenticated %}
                        <span class="ml-auto text-xs font-normal text-green-400 bg-green-500/10 px-2.5 py-1 rounded-lg">
                            <i class="fas fa-check-circle mr-1"></i>{{ user.get_full_name|default:user.username }}
                        </span>
                        {% endif %}
                    </h2>
                    <form id="checkout-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-1">Nombre completo *</label>
                            <input type="text" id="c-name" required placeholder="Tu nombre completo"
                                value="{{ prefill.name|default:'' }}"
                                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:border-red-500 focus:ring-2 focus:ring-red-500/20 transition">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-300 mb-1">Email *</label>
                                <input type="email" id="c-email" required placeholder="tu@email.com"
                                    value="{{ prefill.email|default:'' }}"
                                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:border-red-500 focus:ring-2 focus:ring-red-500/20 transition">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-300 mb-1">Teléfono *</label>
                                <input type="tel" id="c-phone" required placeholder="+57 324 4011967"
                                    value="{{ prefill.phone|default:'' }}"
                                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:border-red-500 focus:ring-2 focus:ring-red-500/20 transition">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-300 mb-1">Tipo de documento *</label>
                                <select id="c-doc-type" required
                                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-red-500 focus:ring-2 focus:ring-red-500/20 transition">
                                    <option value="">— Selecciona —</option>
                                    <option value="CC">Cédula de ciudadanía</option>
                                    <option value="CE">Cédula de extranjería</option>
                                    <option value="PA">Pasaporte</option>
                                    <option value="NIT">NIT</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-300 mb-1">Número de documento *</label>
                                <input type="text" id="c-document" required placeholder="Número de documento"
                                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:border-red-500 focus:ring-2 focus:ring-red-500/20 transition">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-300 mb-1">País *</label>
                                <select id="c-country" required
                                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-red-500 focus:ring-2 focus:ring-red-500/20 transition">
                                    <option value="">— Selecciona país —</option>
                                    {% for c in countries %}
                                    <option value="{{ c.pk }}" data-iso2="{{ c.iso2 }}" data-name="{{ c.name }}">{{ c.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-300 mb-1">Departamento *</label>
                                <select id="c-state" required
                                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-red-500 focus:ring-2 focus:ring-red-500/20 transition">
                                    <option value="">— Selecciona departamento —</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-300 mb-1">Ciudad *</label>
                                <select id="c-city" required
                                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:border-red-500 focus:ring-2 focus:ring-red-500/20 transition">
                                    <option value="">— Selecciona ciudad —</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-1">Dirección de envío *</label>
                            <textarea id="c-address" rows="2" required placeholder="Calle, número, barrio…"
                                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:border-red-500 focus:ring-2 focus:ring-red-500/20 transition resize-none">{{ prefill.address|default:'' }}</textarea>
                        </div>

                        {% csrf_token %}
                        <div id="checkout-error" class="hidden bg-red-900/30 border border-red-700 text-red-300 rounded-lg p-3 text-sm">
                        </div>

                        <button type="submit" id="checkout-pay-btn"
                            class="w-full py-4 bg-gradient-to-r from-red-600 to-red-700 text-white font-bold text-lg rounded-xl hover:from-red-500 hover:to-red-600 transition-all duration-300 shadow-lg flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-credit-card"></i>
                            <span id="pay-btn-text">Pagar con Wompi</span>
                            <span id="pay-btn-total" class="ml-1"></span>
                        </button>

                        <div class="flex items-center justify-center gap-4 text-gray-500 text-xs mt-2">
                            <span><i class="fas fa-shield-alt mr-1"></i> Pago seguro</span>
                            <span><i class="fas fa-lock mr-1"></i> Encriptado SSL</span>
                            <span><i class="fas fa-credit-card mr-1"></i> Wompi</span>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Order Summary (2 cols) -->
            <div class="lg:col-span-2">
                <div class="bg-gray-900 border border-gray-800 rounded-2xl p-6 sticky top-24">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-shopping-bag text-red-500"></i> Resumen del pedido
                    </h2>
                    <div id="checkout-items" class="space-y-3 mb-4 max-h-64 overflow-y-auto">
                    </div>
                    <div class="border-t border-gray-800 pt-4 space-y-2">
                        <div class="flex justify-between text-gray-400 text-sm">
                            <span>Subtotal</span>
                            <span id="summary-subtotal" class="text-white font-semibold">$0</span>
                        </div>
                        <div class="flex justify-between text-gray-400 text-sm">
                            <span>Envío</span>
                            <span id="summary-shipping" class="text-white font-semibold">$12.000</span>
                        </div>
                        <div class="flex justify-between text-white font-bold text-lg pt-2 border-t border-gray-800">
                            <span>Total</span>
                            <span id="summary-total" class="text-red-400">$0</span>
                        </div>
                    </div>
                    <a href="{% url 'core:store' %}" class="block text-center text-gray-500 text-sm mt-4 hover:text-red-400 transition">
                        <i class="fas fa-arrow-left mr-1"></i> Volver a la tienda
                    </a>
                </div>
            </div>

        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://checkout.wompi.co/widget.js"></script>
<script>
(function() {
    var CART_KEY = 'megadominio_store_cart';
    var WOMPI_PUBLIC_KEY = '{{ wompi_public_key }}';
    var DIGITAL_PLAN_SLUGS = {{ digital_plan_slugs|safe }};

    function getCart() {
        try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
        catch(e) { return []; }
    }

    // Render summary
    var cart = getCart();
    if (cart.length === 0) {
        window.location.href = '{% url "core:store" %}';
        return;
    }

    var itemsEl = document.getElementById('checkout-items');
    var subtotalEl = document.getElementById('summary-subtotal');
    var totalEl = document.getElementById('summary-total');
    var payBtnTotal = document.getElementById('pay-btn-total');
    var total = 0;

    cart.forEach(function(item) {
        var lineTotal = item.price * item.qty;
        total += lineTotal;
        var div = document.createElement('div');
        div.className = 'flex items-center gap-3 bg-gray-800/50 rounded-lg p-2';
        var thumb = item.image
            ? '<img src="' + item.image + '" alt="' + item.name + '" class="w-20 h-20 rounded-xl object-contain bg-gray-700 flex-shrink-0 p-1.5">'
            : '<span class="w-20 h-20 rounded-xl bg-gray-700 flex items-center justify-center flex-shrink-0 text-red-400 text-2xl"><i class="fas ' + (item.icon || 'fa-box') + '"></i></span>';
        div.innerHTML =
            thumb +
            '<div class="flex-1 min-w-0">' +
                '<p class="text-white text-sm font-semibold truncate">' + item.name + '</p>' +
                '<p class="text-gray-500 text-xs">x' + item.qty + ' — ' + item.price.toLocaleString() + ' c/u</p>' +
            '</div>' +
            '<span class="text-white font-bold text-sm">' + lineTotal.toLocaleString() + '</span>';
        itemsEl.appendChild(div);
    });

    var allDigital = Array.isArray(cart) && cart.length > 0 && cart.every(function(it){ return DIGITAL_PLAN_SLUGS.indexOf(it.id) !== -1; });
    var shipping = allDigital ? 0 : 12000;
    var displayedShipping = document.getElementById('summary-shipping');
    if (displayedShipping) {
        displayedShipping.textContent = '$' + shipping.toLocaleString();
    }
    subtotalEl.textContent = '$' + total.toLocaleString();
    totalEl.textContent = '$' + (total + shipping).toLocaleString();
    payBtnTotal.textContent = '— $' + (total + shipping).toLocaleString();

    if (allDigital) {
        var titleEl = document.getElementById('checkout-section-title');
        if (titleEl) titleEl.textContent = 'Datos de facturación';
        var countryEl = document.getElementById('c-country');
        var stateEl = document.getElementById('c-state');
        var cityEl = document.getElementById('c-city');
        var addressEl = document.getElementById('c-address');

        function hideField(el){
            if (!el) return;
            el.removeAttribute('required');
            el.disabled = true;
            var wrap = el.closest('div');
            if (wrap) wrap.style.display = 'none';
        }
        hideField(countryEl);
        hideField(stateEl);
        hideField(cityEl);
        hideField(addressEl);

        if (displayedShipping && displayedShipping.parentElement) {
            displayedShipping.parentElement.style.display = 'none';
        }
    }

    // Form submit
    var form = document.getElementById('checkout-form');
    var errorEl = document.getElementById('checkout-error');
    var payBtn = document.getElementById('checkout-pay-btn');

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        errorEl.classList.add('hidden');
        payBtn.disabled = true;
        document.getElementById('pay-btn-text').textContent = 'Procesando...';

        var countrySelect = document.getElementById('c-country');
        var stateSelect = document.getElementById('c-state');
        var citySelect = document.getElementById('c-city');
        var countryName = countrySelect.options[countrySelect.selectedIndex] ? countrySelect.options[countrySelect.selectedIndex].getAttribute('data-name') || '' : '';
        var stateName = stateSelect.options[stateSelect.selectedIndex] ? stateSelect.options[stateSelect.selectedIndex].textContent.trim() : '';
        var cityName = citySelect.options[citySelect.selectedIndex] ? citySelect.options[citySelect.selectedIndex].textContent.trim() : '';

        var payload = {
            items: cart,
            customer: {
                name: document.getElementById('c-name').value.trim(),
                email: document.getElementById('c-email').value.trim(),
                phone: document.getElementById('c-phone').value.trim(),
                doc_type: document.getElementById('c-doc-type').value,
                document: document.getElementById('c-document').value.trim(),
                country: countryName,
                state: stateName,
                city: cityName,
                address: document.getElementById('c-address').value.trim(),
            }
        };

        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('{% url "store:checkout" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify(payload),
        })
        .then(function(resp) { return resp.json(); })
        .then(function(data) {
            if (data.error) {
                errorEl.textContent = data.error;
                errorEl.classList.remove('hidden');
                payBtn.disabled = false;
                document.getElementById('pay-btn-text').textContent = 'Pagar con Wompi';
                return;
            }

            // Open Wompi checkout widget
            var checkout = new WidgetCheckout({
                currency: data.currency,
                amountInCents: data.amount_cents,
                reference: data.reference,
                publicKey: data.public_key,
                redirectUrl: data.redirect_url,
                customerData: {
                    email: data.customer_email,
                    fullName: data.customer_name,
                    phoneNumber: data.customer_phone,
                    phoneNumberPrefix: '+57',
                },
            });

            checkout.open(function(result) {
                var tx = result.transaction;
                if (tx) {
                    // Redirect to result page
                    window.location.href = data.redirect_url + '&id=' + tx.id;
                } else {
                    payBtn.disabled = false;
                    document.getElementById('pay-btn-text').textContent = 'Pagar con Wompi';
                }
            });
        })
        .catch(function(err) {
            console.error(err);
            errorEl.textContent = 'Error de conexión. Intenta de nuevo.';
            errorEl.classList.remove('hidden');
            payBtn.disabled = false;
            document.getElementById('pay-btn-text').textContent = 'Pagar con Wompi';
        });
    });

})();

/* ── Cascading geo selects + IP geolocation + prefill ── */
(function(){
    var countryEl = document.getElementById('c-country');
    var stateEl = document.getElementById('c-state');
    var cityEl = document.getElementById('c-city');
    if (!countryEl || !stateEl || !cityEl) return;

    var PREFILL_COUNTRY = '{{ prefill.country_id|default:"" }}';
    var PREFILL_STATE = '{{ prefill.state_id|default:"" }}';
    var PREFILL_CITY = '{{ prefill.city_id|default:"" }}';

    function loadOptions(url, params, selectEl, placeholder, selectedId, callback) {
        var qs = new URLSearchParams(params).toString();
        selectEl.innerHTML = '<option value="">' + placeholder + '</option>';
        selectEl.disabled = true;
        fetch(url + '?' + qs)
            .then(function(r){ return r.json(); })
            .then(function(data){
                data.forEach(function(item){
                    var opt = document.createElement('option');
                    opt.value = item.id;
                    opt.textContent = item.name;
                    if (selectedId && String(item.id) === String(selectedId)) opt.selected = true;
                    selectEl.appendChild(opt);
                });
                selectEl.disabled = false;
                if (callback) callback();
            });
    }

    countryEl.addEventListener('change', function(){
        stateEl.innerHTML = '<option value="">— Selecciona departamento —</option>';
        cityEl.innerHTML = '<option value="">— Selecciona ciudad —</option>';
        if (this.value) {
            loadOptions('{% url "core:api_states" %}', {country_id: this.value}, stateEl, '— Selecciona departamento —');
        }
    });

    stateEl.addEventListener('change', function(){
        cityEl.innerHTML = '<option value="">— Selecciona ciudad —</option>';
        if (this.value) {
            loadOptions('{% url "core:api_cities" %}', {state_id: this.value}, cityEl, '— Selecciona ciudad —');
        }
    });

    /* Pre-fill from user's saved address */
    if (PREFILL_COUNTRY) {
        countryEl.value = PREFILL_COUNTRY;
        loadOptions('{% url "core:api_states" %}', {country_id: PREFILL_COUNTRY}, stateEl, '— Selecciona departamento —', PREFILL_STATE, function(){
            if (PREFILL_STATE) {
                loadOptions('{% url "core:api_cities" %}', {state_id: PREFILL_STATE}, cityEl, '— Selecciona ciudad —', PREFILL_CITY);
            }
        });
        return;
    }

    /* Auto-detect country by IP */
    function selectByIso2(iso2) {
        var opt = countryEl.querySelector('option[data-iso2="' + iso2 + '"]');
        if (opt) {
            countryEl.value = opt.value;
            countryEl.dispatchEvent(new Event('change'));
            return true;
        }
        return false;
    }

    fetch('https://ipapi.co/json/', {mode: 'cors'})
        .then(function(r){ return r.json(); })
        .then(function(data){
            if (!data.country_code || !selectByIso2(data.country_code)) {
                selectByIso2('CO');
            }
        })
        .catch(function(){
            selectByIso2('CO');
        });
})();
</script>
{% endblock %}
