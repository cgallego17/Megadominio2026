{% extends 'core/dashboard_base.html' %}
{% load humanize %}

{% block dashboard_title %}Orden {{ order.number }}{% endblock %}
{% block dashboard_heading %}Orden {{ order.number }}{% endblock %}
{% block dashboard_desc %}Detalle de la orden{% endblock %}

{% block dashboard_actions %}
<a href="{% url 'core:dashboard_order_edit' order.pk %}" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-800 text-gray-300 text-sm font-semibold rounded-lg hover:bg-gray-700 transition">
    <i class="fas fa-edit"></i> Editar
</a>
<a href="{% url 'core:dashboard_order_delete' order.pk %}" class="inline-flex items-center gap-2 px-4 py-2 bg-red-600/20 text-red-400 text-sm font-semibold rounded-lg hover:bg-red-600 hover:text-white transition">
    <i class="fas fa-trash"></i> Eliminar
</a>
<a href="{% url 'core:dashboard_orders' %}" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-800 text-gray-300 text-sm font-semibold rounded-lg hover:bg-gray-700 transition">
    <i class="fas fa-arrow-left"></i> Volver
</a>
{% endblock %}

{% block dashboard_content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Order info -->
    <div class="lg:col-span-2 space-y-6">
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
            <h3 class="text-white font-bold text-lg mb-4">Información de la orden</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Número</p>
                    <p class="text-white font-bold">{{ order.number }}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Estado</p>
                    {% if order.status == 'pending' %}
                    <span class="px-2 py-0.5 text-xs font-bold rounded-full bg-yellow-500/20 text-yellow-400">Pendiente</span>
                    {% elif order.status == 'confirmed' %}
                    <span class="px-2 py-0.5 text-xs font-bold rounded-full bg-blue-500/20 text-blue-400">Confirmada</span>
                    {% elif order.status == 'processing' %}
                    <span class="px-2 py-0.5 text-xs font-bold rounded-full bg-purple-500/20 text-purple-400">En proceso</span>
                    {% elif order.status == 'shipped' %}
                    <span class="px-2 py-0.5 text-xs font-bold rounded-full bg-cyan-500/20 text-cyan-400">Enviada</span>
                    {% elif order.status == 'delivered' %}
                    <span class="px-2 py-0.5 text-xs font-bold rounded-full bg-green-500/20 text-green-400">Entregada</span>
                    {% elif order.status == 'cancelled' %}
                    <span class="px-2 py-0.5 text-xs font-bold rounded-full bg-red-500/20 text-red-400">Cancelada</span>
                    {% endif %}
                </div>
                <div>
                    <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Fecha</p>
                    <p class="text-gray-300">{{ order.created_at|date:"d/m/Y H:i" }}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Creada por</p>
                    <p class="text-gray-300">{{ order.created_by|default:"—" }}</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
            <h3 class="text-white font-bold text-lg mb-4">Datos del cliente</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Nombre</p>
                    <p class="text-white font-semibold">{{ order.customer_name }}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Email</p>
                    <p class="text-gray-300">{{ order.customer_email|default:"—" }}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Teléfono</p>
                    <p class="text-gray-300">{{ order.customer_phone|default:"—" }}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Documento</p>
                    <p class="text-gray-300">{{ order.customer_document|default:"—" }}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Ciudad</p>
                    <p class="text-gray-300">{{ order.customer_city|default:"—" }}</p>
                </div>
                <div class="sm:col-span-2">
                    <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Dirección</p>
                    <p class="text-gray-300">{{ order.customer_address|default:"—" }}</p>
                </div>
            </div>
        </div>

        <!-- Payment info -->
        {% if order.wompi_transaction_id or order.payment_status != 'pending' %}
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
            <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2">
                <i class="fas fa-credit-card text-red-500"></i> Información de pago
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Estado de pago</p>
                    {% if order.payment_status == 'approved' %}
                    <span class="px-2 py-0.5 text-xs font-bold rounded-full bg-green-500/20 text-green-400">Aprobado</span>
                    {% elif order.payment_status == 'declined' %}
                    <span class="px-2 py-0.5 text-xs font-bold rounded-full bg-red-500/20 text-red-400">Rechazado</span>
                    {% elif order.payment_status == 'voided' %}
                    <span class="px-2 py-0.5 text-xs font-bold rounded-full bg-orange-500/20 text-orange-400">Anulado</span>
                    {% elif order.payment_status == 'error' %}
                    <span class="px-2 py-0.5 text-xs font-bold rounded-full bg-red-500/20 text-red-400">Error</span>
                    {% else %}
                    <span class="px-2 py-0.5 text-xs font-bold rounded-full bg-yellow-500/20 text-yellow-400">Pendiente</span>
                    {% endif %}
                </div>
                <div>
                    <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Método de pago</p>
                    <p class="text-gray-300">{{ order.payment_method|default:"—" }}</p>
                </div>
                {% if order.wompi_transaction_id %}
                <div class="sm:col-span-2">
                    <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Wompi Transaction ID</p>
                    <p class="text-gray-300 font-mono text-xs">{{ order.wompi_transaction_id }}</p>
                </div>
                {% endif %}
                {% if order.paid_at %}
                <div>
                    <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Fecha de pago</p>
                    <p class="text-gray-300">{{ order.paid_at|date:"d/m/Y H:i" }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Items -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-800">
                <h3 class="text-white font-bold text-lg">Items de la orden</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-800 text-gray-400 text-xs uppercase tracking-wider">
                            <th class="text-left px-5 py-3">Producto</th>
                            <th class="text-center px-5 py-3">Cantidad</th>
                            <th class="text-right px-5 py-3">Precio unit.</th>
                            <th class="text-right px-5 py-3">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800/50">
                        {% for item in order.items.all %}
                        <tr>
                            <td class="px-5 py-3 text-white">{{ item.description }}</td>
                            <td class="px-5 py-3 text-center text-gray-300">{{ item.quantity }}</td>
                            <td class="px-5 py-3 text-right text-gray-300">{{ item.unit_price|intcomma }}</td>
                            <td class="px-5 py-3 text-right text-white font-semibold">{{ item.subtotal|intcomma }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-5 py-8 text-center text-gray-500">No hay items en esta orden</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if order.notes %}
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
            <h3 class="text-white font-bold text-lg mb-3">Notas</h3>
            <p class="text-gray-300 text-sm leading-relaxed">{{ order.notes }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar: totals + status change -->
    <div class="space-y-6">
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
            <h3 class="text-white font-bold text-lg mb-4">Resumen</h3>
            <div class="space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-400">Subtotal</span>
                    <span class="text-white">{{ order.subtotal|intcomma }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-400">Envío</span>
                    <span class="text-white">{{ order.shipping_cost|intcomma }}</span>
                </div>
                {% if order.discount %}
                <div class="flex justify-between text-sm">
                    <span class="text-gray-400">Descuento</span>
                    <span class="text-red-400">-{{ order.discount|intcomma }}</span>
                </div>
                {% endif %}
                <div class="border-t border-gray-800 pt-3 flex justify-between">
                    <span class="text-white font-bold">Total</span>
                    <span class="text-white font-extrabold text-xl">{{ order.total|intcomma }}</span>
                </div>
            </div>
        </div>

        <!-- Change status -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
            <h3 class="text-white font-bold text-lg mb-4">Cambiar estado</h3>
            <form method="post" action="{% url 'core:dashboard_order_update_status' order.pk %}">
                {% csrf_token %}
                <select name="status" class="w-full bg-gray-800 border border-gray-700 text-gray-100 text-sm rounded-lg px-3 py-2.5 focus:border-red-500 focus:ring-1 focus:ring-red-500 mb-3">
                    <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pendiente</option>
                    <option value="confirmed" {% if order.status == 'confirmed' %}selected{% endif %}>Confirmada</option>
                    <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>En proceso</option>
                    <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>Enviada</option>
                    <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>Entregada</option>
                    <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Cancelada</option>
                </select>
                <button type="submit" class="w-full py-2.5 bg-red-600 text-white text-sm font-semibold rounded-lg hover:bg-red-700 transition">
                    <i class="fas fa-sync-alt mr-1"></i> Actualizar estado
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
