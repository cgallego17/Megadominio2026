{% extends 'core/dashboard_base.html' %}
{% load crispy_forms_tags %}

{% block dashboard_title %}{{ title }}{% endblock %}
{% block dashboard_heading %}{{ title }}{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
.select2-container--default .select2-selection--single {
    background-color: #1f2937 !important;
    border: 1px solid #374151 !important;
    color: #f3f4f6 !important;
    border-radius: 0.5rem !important;
    height: 42px !important;
    padding: 0.6rem 0.75rem !important;
}
.select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #f3f4f6 !important;
    line-height: 28px !important;
}
.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 40px !important;
}
.select2-dropdown {
    background-color: #1f2937 !important;
    border: 1px solid #374151 !important;
    border-radius: 0.5rem !important;
}
.select2-container--default .select2-results__option {
    color: #f3f4f6 !important;
    background-color: #1f2937 !important;
}
.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #dc2626 !important;
    color: white !important;
}
.select2-container--default .select2-search--dropdown .select2-search__field {
    background-color: #111827 !important;
    border: 1px solid #374151 !important;
    color: #f3f4f6 !important;
    border-radius: 0.5rem !important;
}
.select2-container--default .select2-results__option[aria-selected="true"] {
    background-color: #374151 !important;
}
</style>
{% endblock %}

{% block dashboard_actions %}
<a href="{% if back_pk %}{% url back_url back_pk %}{% else %}{% url back_url %}{% endif %}" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-800 text-gray-300 text-sm font-semibold rounded-lg hover:bg-gray-700 transition">
    <i class="fas fa-arrow-left"></i> Volver
</a>
{% endblock %}

{% block dashboard_content %}
<div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
    <div class="p-6">
        <form method="post">
            {% csrf_token %}
            <div class="dash-form">
                {{ form|crispy }}
            </div>
            <div class="mt-6 pt-6 border-t border-gray-800">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-white"><i class="fas fa-list-ul mr-2 text-red-400"></i>Items de la cuenta de cobro</h3>
                    <button type="button" class="add-form-row inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white text-sm font-semibold rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-plus"></i> Agregar item
                    </button>
                </div>
                {{ formset.management_form }}
                <div id="formset-container" class="space-y-3">
                    {% for form in formset %}
                    <div class="formset-row bg-gray-800/40 border border-gray-700/50 rounded-xl p-4 dash-form">
                        {{ form|crispy }}
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-4">
                    <button type="button" class="add-form-row inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white text-sm font-semibold rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-plus"></i> Agregar item
                    </button>
                </div>
            </div>
            
            <!-- Totalizador -->
            <div class="mt-6 pt-6 border-t border-gray-800">
                <div class="bg-gray-800/60 rounded-xl p-6 max-w-md ml-auto">
                    <h3 class="text-sm font-bold text-white mb-4"><i class="fas fa-calculator mr-2 text-red-400"></i>Resumen</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between text-gray-300">
                            <span>Subtotal:</span>
                            <span id="calc-subtotal" class="font-bold">$0 COP</span>
                        </div>
                        <div class="flex justify-between text-gray-300">
                            <span>Descuento:</span>
                            <span id="calc-discount" class="font-bold text-green-400">$0 COP</span>
                        </div>
                        <div class="flex justify-between text-gray-300">
                            <span>IVA:</span>
                            <span id="calc-tax" class="font-bold">$0 COP</span>
                        </div>
                        <div class="pt-3 border-t border-gray-700 flex justify-between text-white text-lg">
                            <span class="font-bold">TOTAL:</span>
                            <span id="calc-total" class="font-bold text-red-400">$0 COP</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3 mt-6 pt-6 border-t border-gray-800">
                <button type="submit" class="inline-flex items-center gap-2 px-6 py-2.5 bg-red-600 text-white text-sm font-semibold rounded-lg hover:bg-red-700 transition">
                    <i class="fas fa-save"></i> Guardar
                </button>
                <a href="{% if back_pk %}{% url back_url back_pk %}{% else %}{% url back_url %}{% endif %}" class="inline-flex items-center gap-2 px-6 py-2.5 bg-gray-800 text-gray-300 text-sm font-semibold rounded-lg hover:bg-gray-700 transition">Cancelar</a>
            </div>
        </form>
    </div>
</div>
<style>
    .dash-form label { color: #d1d5db; font-size: 0.875rem; font-weight: 600; }
    .dash-form input, .dash-form select, .dash-form textarea {
        background: #1f2937 !important; border: 1px solid #374151 !important; color: #f3f4f6 !important;
        border-radius: 0.5rem !important; padding: 0.6rem 0.75rem !important; font-size: 0.875rem !important;
    }
    .dash-form input:focus, .dash-form select:focus, .dash-form textarea:focus {
        border-color: #dc2626 !important; box-shadow: 0 0 0 2px rgba(220,38,38,0.15) !important; outline: none !important;
    }
    .dash-form .form-check-input { accent-color: #dc2626; }
    .dash-form .text-muted, .dash-form .form-text { color: #6b7280 !important; font-size: 0.75rem !important; }
    .dash-form .asteriskField { color: #ef4444; }
</style>
{% endblock %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar Select2 para el selector de clientes
        $('#id_client').select2({
            placeholder: 'Buscar cliente...',
            allowClear: true,
            width: '100%',
            language: {
                noResults: function() {
                    return "No se encontraron resultados";
                },
                searching: function() {
                    return "Buscando...";
                }
            }
        });
        
        // Inicializar Select2 para cotización si existe
        if ($('#id_quote').length) {
            $('#id_quote').select2({
                placeholder: 'Seleccionar cotización (opcional)...',
                allowClear: true,
                width: '100%',
                language: {
                    noResults: function() {
                        return "No se encontraron resultados";
                    },
                    searching: function() {
                        return "Buscando...";
                    }
                }
            });
        }
        
        // Función para inicializar Select2 en selectores de servicios
        function initServiceSelects() {
            $('select[name$="-service"]').each(function() {
                if (!$(this).hasClass('select2-hidden-accessible')) {
                    $(this).select2({
                        placeholder: 'Buscar servicio...',
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $(this).parent(),
                        language: {
                            noResults: function() {
                                return "No se encontraron resultados";
                            },
                            searching: function() {
                                return "Buscando...";
                            }
                        }
                    });
                }
            });
        }
        
        // Inicializar Select2 en servicios existentes
        initServiceSelects();
        
        const container = document.getElementById('formset-container');
        const totalInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
        let prefix = null;
        if (totalInput) {
            const m = (totalInput.getAttribute('name') || '').match(/^(.+)-TOTAL_FORMS$/);
            prefix = m ? m[1] : null;
        }
        
        // Función para formatear números como moneda
        function formatMoney(value) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }
        
        // Función para calcular totales
        function calculateTotals() {
            let subtotal = 0;
            
            // Calcular subtotal de todos los items
            container.querySelectorAll('.formset-row').forEach(row => {
                // Verificar si el row está marcado para eliminar
                const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
                if (deleteCheckbox && deleteCheckbox.checked) return;
                if (row.style.display === 'none') return;
                
                const quantityInput = row.querySelector('input[name$="-quantity"]');
                const priceInput = row.querySelector('input[name$="-unit_price"]');
                
                if (quantityInput && priceInput) {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    subtotal += quantity * price;
                }
            });
            
            // Obtener valores de descuento e impuesto del formulario principal
            const discountPercentInput = document.querySelector('input[name="discount_percentage"]');
            const taxPercentInput = document.querySelector('input[name="tax_percentage"]');
            
            const discountPercent = parseFloat(discountPercentInput?.value) || 0;
            const taxPercent = parseFloat(taxPercentInput?.value) || 0;
            
            // Calcular descuento
            const discountAmount = (subtotal * discountPercent) / 100;
            const subtotalAfterDiscount = subtotal - discountAmount;
            
            // Calcular impuesto
            const taxAmount = (subtotalAfterDiscount * taxPercent) / 100;
            
            // Calcular total
            const total = subtotalAfterDiscount + taxAmount;
            
            // Actualizar los displays
            document.getElementById('calc-subtotal').textContent = formatMoney(subtotal);
            document.getElementById('calc-discount').textContent = formatMoney(discountAmount);
            document.getElementById('calc-tax').textContent = formatMoney(taxAmount);
            document.getElementById('calc-total').textContent = formatMoney(total);
        }
        
        // Agregar listeners a todos los campos que afectan el cálculo
        function addCalculationListeners() {
            // Listeners en items
            container.querySelectorAll('input[name$="-quantity"], input[name$="-unit_price"]').forEach(input => {
                input.addEventListener('input', calculateTotals);
                input.addEventListener('change', calculateTotals);
            });
            
            // Listeners en descuento e impuesto
            const discountInput = document.querySelector('input[name="discount_percentage"]');
            const taxInput = document.querySelector('input[name="tax_percentage"]');
            
            if (discountInput) {
                discountInput.addEventListener('input', calculateTotals);
                discountInput.addEventListener('change', calculateTotals);
            }
            if (taxInput) {
                taxInput.addEventListener('input', calculateTotals);
                taxInput.addEventListener('change', calculateTotals);
            }
        }
        
        function clearRowValues(row, index) {
            const re = new RegExp(`${prefix}-\\d+`, 'g');
            row.querySelectorAll('input, select, textarea, label').forEach(el => {
                if (el.tagName === 'LABEL') {
                    const f = el.getAttribute('for');
                    if (f) el.setAttribute('for', f.replace(re, `${prefix}-${index}`));
                    return;
                }
                const name = el.getAttribute('name');
                if (name) el.setAttribute('name', name.replace(re, `${prefix}-${index}`));
                const id = el.getAttribute('id');
                if (id) el.setAttribute('id', id.replace(re, `${prefix}-${index}`));
                if (el.type === 'hidden') {
                    const nm = el.getAttribute('name') || '';
                    if (/-id$/.test(nm)) el.value = '';
                } else if (el.type === 'checkbox' || el.type === 'radio') {
                    el.checked = false;
                } else if (el.tagName === 'SELECT') {
                    el.selectedIndex = 0;
                } else {
                    el.value = '';
                }
            });
            row.querySelectorAll('.invalid-feedback, .text-danger, .text-red-400').forEach(n => n.remove());
        }
        
        // Obtener todos los botones de agregar item
        const addButtons = document.querySelectorAll('.add-form-row');
        
        if (addButtons.length > 0 && container && totalInput && prefix) {
            addButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const count = parseInt(totalInput.value, 10) || 0;
                    const template = container.querySelector('.formset-row');
                    if (!template) return;
                    const newRow = template.cloneNode(true);
                    clearRowValues(newRow, count);
                    container.appendChild(newRow);
                    totalInput.value = count + 1;
                    
                    // Inicializar Select2 en el nuevo row
                    initServiceSelects();
                    
                    // Agregar listeners al nuevo row
                    addCalculationListeners();
                    calculateTotals();
                });
            });
        }
        
        // Inicializar
        addCalculationListeners();
        calculateTotals();
    });
</script>
{% endblock %}
